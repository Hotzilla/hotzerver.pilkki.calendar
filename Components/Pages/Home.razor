@page "/"
@rendermode InteractiveServer
@inject hotzerver.pilkki.calendar.Data.WeekendService WeekendService

<PageTitle>Pilkki viikonloput</PageTitle>

<div class="page">
    <header class="top-header">
        <h1>Pilkki viikonloppusuunnittelu</h1>
        <p>Valitse paras viikonloppu pilkkireissulle (perjantai–sunnuntai).</p>
    </header>

    <section class="filters">
        <label>
            Vuosi
            <input type="number" min="2026" max="2100" @bind="SelectedYear" @bind:after="LoadDataAsync" />
        </label>

        <label>
            Reissu
            <select @bind="SelectedSeason" @bind:after="LoadDataAsync">
                <option value="@TripSeason.PilkkiI">Pilkki I/@SelectedYear (helmi–huhti)</option>
                <option value="@TripSeason.PilkkiII">Pilkki II/@SelectedYear (loka–marras)</option>
            </select>
        </label>
    </section>

    @if (Weekends.Count > 0)
    {
        <div class="deadline-info @(Weekends[0].IsDeadlineReached ? "deadline-reached" : string.Empty)">
            <span class="deadline-badge">Määräaika</span>
            <strong>@Weekends[0].DeadlineDate.ToString("dd.MM.yyyy")</strong>
            @if (Weekends[0].IsDeadlineReached)
            {
                <span>Määräaika on saavutettu. OK/EI käy -vastauksia ei voi enää muokata.</span>
            }
            else
            {
                <span>OK/EI käy -vastaukset tulee antaa tähän mennessä.</span>
            }
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <div class="error">@ErrorMessage</div>
    }

    <section class="weekend-grid">
        @foreach (var weekend in Weekends)
        {
            <article class="weekend-card @(ShouldHighlightWeekend(weekend) ? "best-weekend" : string.Empty)">
                <h2>@WeekendTitle(weekend)</h2>
                @if (ShouldHighlightWeekend(weekend))
                {
                    <p class="best-weekend-label">Suositus: vähiten EI käy -merkintöjä</p>
                }
                <div class="names">
                    @foreach (var person in weekend.Participants)
                    {
                        <button type="button" class="name-chip @(person.IsAvailable ? "ok" : "not-ok")"
                                title="@TooltipText(person)"
                                disabled="@weekend.IsDeadlineReached"
                                @onclick="() => OpenMarkDialog(weekend.Friday, person)">
                            @person.FirstName
                        </button>
                    }
                </div>
            </article>
        }
    </section>
</div>

@if (DialogOpen && SelectedPerson is not null)
{
    <div class="modal-backdrop" @onclick="CloseDialog">
        <div class="modal" @onclick:stopPropagation="true">
            <h3>@DialogTitle</h3>
            <p>
                <strong>@SelectedPerson.FirstName</strong> / @SelectedWeekend?.ToString("dd.MM.yyyy")
            </p>

            <EditForm Model="Form" OnValidSubmit="SubmitAvailabilityChange">
                <DataAnnotationsValidator />
                <ValidationSummary />

<<<<<<< HEAD
                @if (!string.IsNullOrWhiteSpace(SelectedPerson.Comment))
                {
                    <div class="existing-comment">
                        <span class="existing-comment-title">Nykyinen kommentti</span>
                        <p>@SelectedPerson.Comment</p>
                    </div>
                }
                
=======
                @if (!string.IsNullOrWhiteSpace(DialogErrorMessage))
                {
                    <div class="error">@DialogErrorMessage</div>
                }

>>>>>>> a6936b82a9a93b6bc225fe4fd35fdaf5634b1e2a
                <label>
                    Sukunimi (pakollinen)
                    <InputText @bind-Value="Form.LastName" />
                </label>

                @if (!IsMarkingOk)
                {


                    <label>
                        Kommentti (valinnainen)
                        <InputTextArea @bind-Value="Form.Comment" />
                    </label>
                }

                <div class="actions">
                    <button type="button" class="secondary" @onclick="CloseDialog">Peruuta</button>
                    <button type="submit" class="primary">@DialogSaveButtonText</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private int SelectedYear { get; set; } = 2026;
    private TripSeason SelectedSeason { get; set; } = TripSeason.PilkkiI;
    private List<WeekendStatusViewModel> Weekends { get; set; } = [];
    private string? ErrorMessage { get; set; }

    private bool DialogOpen { get; set; }
    private DateOnly? SelectedWeekend { get; set; }
    private ParticipantStatusViewModel? SelectedPerson { get; set; }
    private bool IsMarkingOk { get; set; }
    private string? DialogErrorMessage { get; set; }
    private MarkAvailabilityForm Form { get; set; } = new();

    private string DialogTitle => IsMarkingOk ? "Merkitse KÄY" : "Merkitse EI käy";
    private string DialogSaveButtonText => IsMarkingOk ? "Tallenna KÄY" : "Tallenna EI käy";

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        ErrorMessage = null;
        Weekends = await WeekendService.GetWeekendStatusesAsync(SelectedYear, SelectedSeason);
        StateHasChanged();
    }


    private static string WeekendTitle(WeekendStatusViewModel weekend)
    {
        var dateRange = $"{weekend.Friday:dd.MM.} – {weekend.Sunday:dd.MM.yyyy}";
        if (weekend.HolidayTitles.Count == 0)
        {
            return dateRange;
        }

        return $"{dateRange} ({string.Join(", ", weekend.HolidayTitles)})";
    }

    private bool ShouldHighlightWeekend(WeekendStatusViewModel weekend)
    {
        if (Weekends.Count == 0 || !IsDeadlineNearOrPassed(weekend.DeadlineDate))
        {
            return false;
        }

        return weekend.NotOkCount == Weekends.Min(x => x.NotOkCount);
    }

    private static bool IsDeadlineNearOrPassed(DateOnly deadlineDate)
    {
        var today = DateOnly.FromDateTime(DateTime.UtcNow);
        return deadlineDate <= today.AddDays(14);
    }

    private string TooltipText(ParticipantStatusViewModel person)
    {
        if (person.IsAvailable)
        {
            return $"{person.FirstName}: käy";
        }

        return string.IsNullOrWhiteSpace(person.Comment)
            ? $"{person.FirstName}: ei käy"
            : $"{person.FirstName}: ei käy – {person.Comment}";
    }

    private void OpenMarkDialog(DateOnly weekend, ParticipantStatusViewModel person)
    {
        SelectedWeekend = weekend;
        SelectedPerson = person;
        IsMarkingOk = !person.IsAvailable;

        Form = new MarkAvailabilityForm
        {
            Comment = IsMarkingOk ? null : person.Comment
        };

        DialogOpen = true;
        ErrorMessage = null;
        DialogErrorMessage = null;
    }

    private void CloseDialog()
    {
        DialogOpen = false;
        SelectedPerson = null;
        SelectedWeekend = null;
        IsMarkingOk = false;
        DialogErrorMessage = null;
    }

    private async Task SubmitAvailabilityChange()
    {
        if (SelectedPerson is null || SelectedWeekend is null)
        {
            return;
        }

        var error = await WeekendService.SetAvailabilityAsync(
            SelectedPerson.ParticipantId,
            SelectedYear,
            SelectedSeason,
            SelectedWeekend.Value,
            IsMarkingOk,
            Form.LastName,
            Form.Comment);

        if (error is not null)
        {
            DialogErrorMessage = error;
            return;
        }

        CloseDialog();
        await LoadDataAsync();
    }

    private class MarkAvailabilityForm
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Sukunimi on pakollinen")]
        public string LastName { get; set; } = string.Empty;
        public string? Comment { get; set; }
    }
}
